#!/usr/bin/env node 
const figlet = require('figlet')
const Printer = require('@darkobits/lolcatjs')
const txt = figlet.textSync("DOGJUN CLI")
const program = require('commander')
const inquirer = require('inquirer')
const chalk = require('chalk')
const json2ts = require('json2ts')
const ora = require('ora')
const shell = require('shelljs')
const download = require('download-git-repo')
const templateUrl = 'direct:https://github.com/DogJun/dogjun-vue-ssr-cli.git'
program.version(Printer.default.fromString(txt), '-v,--version')
// TODO: æ³¨é‡Šæ‰“å¼€ä¼šå¤±æ•ˆ
// program.option('init', 'ğŸ¶ åˆå§‹åŒ–é¡¹ç›®')
// program.option('json2ts', 'ğŸ† jsonç”Ÿæˆts')
const bindHandler = {
  init () {
    inquirer
      .prompt([
        {
          type: 'text',
          message: 'ğŸ“ƒ è¯·è¾“å…¥æ–‡ä»¶å¤¹çš„åç§°',
          name: 'dirname'
        },
        {
          type: 'list',
          name: 'jskind',
          message: 'ğŸ‘· è¯·ä½¿ç”¨é¡¹ç›®ä½¿ç”¨è¯­è¨€',
          choices: ['ES6', 'Typescript']
        }
      ])
      .then((answers) => {
        const _dirname = answers.dirname;
        if (_dirname) {
          const spinner = ora('â° download template...')
          spinner.start()
          const _pwd = shell.pwd().stdout
          const _projectPath = `${_pwd}/${_dirname}`
          shell.cd(_pwd)
          shell.rm('-rf', _projectPath)
          shell.mkdir(_dirname)
          download(templateUrl, _projectPath, {clone: true,}, err => {
            spinner.stop()
            if (err) {
              console.error(`æ¨¡ç‰ˆä¸‹è½½å¤±è´¥${err.message}`)
            } else {
              shell.sed('-i', 'myblog', _dirname, _projectPath + '/package.json')
            }
          })
        }
      })
  },
  json2ts (jsonUrl) {
    const spinner = ora('â° æ­£åœ¨å¸®çˆ·ç”Ÿæˆä»£ç ä¸­ï¼Œè¯·ç¨å...')
    spinner.start()
    console.log('è¯·æ±‚åœ°å€', jsonUrl)
    const json = {
      code: 1,
      data: [
        { 
          num: 1
        },
        { 
          info: {
            name: 'DogJun'
          }
        }
      ]
    }
  }
}
program.usage('<cmd> [env]')
  .arguments('<cmd> [env]')
  .action(function (cmd, otherParams) {
    const handler = bindHandler[cmd]
    if (handler) {
      handler(otherParams)
    } else {
      console.log(`${chalk.yellow('ğŸ™ éå¸¸é—æ†¾')}ã€${chalk.red(cmd)}ã€‘${chalk.yellow('æš‚ä¸æ”¯æŒ')}`)
    }
  })
program.parse(process.argv)

